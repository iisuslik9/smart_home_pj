<!DOCTYPE html>
<html>
<head>
  <title>Умный дом</title>
  <meta name="viewport" content="width=device-width">
  <style>
    body { font-family: Arial; max-width: 600px; margin: 20px auto; padding: 20px; }
    .control { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 8px; }
    input[type=range] { width: 100%; height: 8px; }
    .value { font-size: 1.2em; font-weight: bold; color: #333; }
    button { padding: 12px 24px; font-size: 16px; margin: 5px; border: none; border-radius: 6px; cursor: pointer; }
    .on { background: #4CAF50; color: white; }
    .off { background: #f44336; color: white; }
  </style>
</head>
<body>
  <h1>Умный дом</h1>
  
  <div class="control">
    <h3>LED 1</h3>
    <input type="range" id="led1" min="0" max="255" value="0">
    <div class="value" id="led1_val">0</div>
  </div>

  <div class="control">
    <h3>LED 2</h3>
    <input type="range" id="led2" min="0" max="255" value="0">
    <div class="value" id="led2_val">0</div>
  </div>

  <div class="control">
    <h3>RGB</h3>
    <input type="color" id="rgb">
    <div class="value" id="rgb_val">#000000</div>
  </div>

  <div class="control">
    <h3>LED Лента</h3>
    <button id="strip_btn" class="off">ВЫКЛ</button>
    <div class="value" id="strip_val">Выкл</div>
  </div>

  <script>
    // данные из Supabase
    const SUPABASE_URL = 'https://yndjuqvejwgxostadikf.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InluZGp1cXZlandneG9zdGFkaWtmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU2MDQzMzAsImV4cCI6MjA4MTE4MDMzMH0.qRzRvFjnKtpoWIOEhsGWsdqgfz0CexO7cZPxZZP6Tus';
    
    // Загрузка текущих значений
    async function loadControls() {
      const response = await fetch(`${SUPABASE_URL}/rest/v1/controls?select=*`, {
        headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` }
      });
      const data = await response.json();
      if (data.length > 0) {
        const ctrl = data[0];
        document.getElementById('led1').value = ctrl.led1;
        document.getElementById('led1_val').textContent = ctrl.led1;
        document.getElementById('led2').value = ctrl.led2;
        document.getElementById('led2_val').textContent = ctrl.led2;
        document.getElementById('rgb').value = `#${ctrl.rgb_r.toString(16).padStart(2,'0')}${ctrl.rgb_g.toString(16).padStart(2,'0')}${ctrl.rgb_b.toString(16).padStart(2,'0')}`;
        document.getElementById('strip_btn').textContent = ctrl.strip ? 'ВКЛ' : 'ВЫКЛ';
        document.getElementById('strip_btn').className = ctrl.strip ? 'on' : 'off';
        document.getElementById('strip_val').textContent = ctrl.strip ? 'Вкл' : 'Выкл';
      }
    }
    
    // Отправка команды
    async function sendCommand(data) {
      await fetch(`${SUPABASE_URL}/rest/v1/controls?upsert=true`, {
        method: 'POST',
        headers: {
          'apikey': SUPABASE_KEY,
          'Authorization': `Bearer ${SUPABASE_KEY}`,
          'Content-Type': 'application/json',
          'Prefer': 'resolution=merge-duplicates'
        },
        body: JSON.stringify(data)
      });
    }
    
    // Обработчики
    document.getElementById('led1').oninput = (e) => {
      document.getElementById('led1_val').textContent = e.target.value;
      sendCommand({ led1: parseInt(e.target.value) });
    };
    
    document.getElementById('led2').oninput = (e) => {
      document.getElementById('led2_val').textContent = e.target.value;
      sendCommand({ led2: parseInt(e.target.value) });
    };
    
    document.getElementById('rgb').onchange = (e) => {
      const rgb = hexToRgb(e.target.value);
      document.getElementById('rgb_val').textContent = e.target.value;
      sendCommand(rgb);
    };
    
    document.getElementById('strip_btn').onclick = async () => {
      const isOn = document.getElementById('strip_btn').textContent === 'ВЫКЛ';
      document.getElementById('strip_btn').textContent = isOn ? 'ВКЛ' : 'ВЫКЛ';
      document.getElementById('strip_btn').className = isOn ? 'on' : 'off';
      document.getElementById('strip_val').textContent = isOn ? 'Вкл' : 'Выкл';
      await sendCommand({ strip: isOn });
    };
    
    function hexToRgb(hex) {
      const r = parseInt(hex.slice(1,3), 16);
      const g = parseInt(hex.slice(3,5), 16);
      const b = parseInt(hex.slice(5,7), 16);
      return { rgb_r: r, rgb_g: g, rgb_b: b };
    }
    
    // Автообновление каждые 2 секунды
    setInterval(loadControls, 2000);
    loadControls();
  </script>
</body>
</html>
