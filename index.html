import { useState, useEffect } from 'react'
import { createClient } from '@supabase/supabase-js'

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL
const supabaseKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY
const supabase = createClient(supabaseUrl, supabaseKey)

export default function Home() {
  const [data, setData] = useState({})
  const [controls, setControls] = useState({})

  useEffect(() => {
    fetchData()
    const interval = setInterval(fetchData, 2000)
    return () => clearInterval(interval)
  }, [])

  const fetchData = async () => {
    const { data: sensor } = await supabase.from('sensor_data').select('*').order('created_at', { ascending: false }).limit(1)
    const { data: ctrl } = await supabase.from('controls').select('*').eq('id', 1)
    if (sensor?.[0]) setData(sensor[0])
    if (ctrl?.[0]) setControls(ctrl[0])
  }

  const updateControl = async (field, value) => {
    const updates = { [field]: value }
    await supabase.from('controls').upsert({ id: 1, ...updates })
  }

  return (
    <div className="min-h-screen bg-gradient-to-br from-blue-900 to-purple-900 p-8">
      <div className="max-w-4xl mx-auto">
        <h1 className="text-4xl font-bold text-white mb-8 text-center">–£–º–Ω—ã–π –¥–æ–º</h1>
        
        {/* –î–∞—Ç—á–∏–∫–∏ */}
        <div className="grid grid-cols-3 gap-6 mb-8">
          <div className="bg-white/20 backdrop-blur-lg p-6 rounded-2xl text-center">
            <div className="text-3xl">üå°Ô∏è {data.temperature?.toFixed(1) || '--'}¬∞C</div>
            <div className="text-white/80">–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞</div>
          </div>
          <div className="bg-white/20 backdrop-blur-lg p-6 rounded-2xl text-center">
            <div className="text-3xl">üíß {data.humidity?.toFixed(1) || '--'}%</div>
            <div className="text-white/80">–í–ª–∞–∂–Ω–æ—Å—Ç—å</div>
          </div>
          <div className="bg-white/20 backdrop-blur-lg p-6 rounded-2xl text-center">
            <div className="text-3xl">‚òÄÔ∏è {data.light || '--'}</div>
            <div className="text-white/80">–û—Å–≤–µ—â—ë–Ω–Ω–æ—Å—Ç—å</div>
          </div>
        </div>

        {/* –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ */}
        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
          {/* –õ–µ–Ω—Ç–∞ + –¢–∞–π–º–µ—Ä */}
          <div className="bg-white/20 backdrop-blur-lg p-6 rounded-2xl">
            <h3 className="text-xl font-bold text-white mb-4">üè† –õ–µ–Ω—Ç–∞</h3>
            <button 
              className={`w-full p-4 rounded-xl text-xl font-bold ${controls.strip ? 'bg-green-500' : 'bg-gray-500'} text-white mb-4`}
              onClick={() => updateControl('strip', !controls.strip)}
            >
              {controls.strip ? '‚úÖ –í–ö–õ' : '‚ùå –í–´–ö–õ'}
            </button>
            <div className="text-white/80 mb-4">
              ‚è∞ –¢–∞–π–º–µ—Ä: {controls.timer_hours || 0}:{controls.timer_minutes?.toString().padStart(2, '0')}
            </div>
            <div className="flex gap-2">
              <input type="number" min="0" max="23" 
                value={controls.timer_hours || 0}
                onChange={(e) => updateControl('timer_hours', parseInt(e.target.value))}
                className="flex-1 p-2 rounded bg-white/30 text-white placeholder-white/50" 
                placeholder="–ß"
              />
              <input type="number" min="0" max="59" 
                value={controls.timer_minutes || 30}
                onChange={(e) => updateControl('timer_minutes', parseInt(e.target.value))}
                className="flex-1 p-2 rounded bg-white/30 text-white placeholder-white/50" 
                placeholder="–ú–∏–Ω"
              />
            </div>
          </div>

          {/* LED */}
          <div className="bg-white/20 backdrop-blur-lg p-6 rounded-2xl">
            <h3 className="text-xl font-bold text-white mb-4">üí° –°–≤–µ—Ç–æ–¥–∏–æ–¥—ã</h3>
            {['led1', 'led2', 'led3'].map(led => (
              <div key={led} className="mb-4">
                <label className="block text-white/80 mb-1">{led.toUpperCase()}</label>
                <input type="range" min="0" max="255" 
                  value={controls[led] || 0}
                  onChange={(e) => updateControl(led, parseInt(e.target.value))}
                  className="w-full h-2 bg-white/30 rounded-lg appearance-none cursor-pointer accent-yellow-400"
                />
                <span className="text-white/80">{controls[led] || 0}</span>
              </div>
            ))}
          </div>
        </div>

        {/* RGB + –ó—É–º–º–µ—Ä */}
        <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
          <div className="bg-white/20 backdrop-blur-lg p-6 rounded-2xl">
            <h3 className="text-xl font-bold text-white mb-4">üåà RGB</h3>
            {['rgb_r', 'rgb_g', 'rgb_b'].map(color => (
              <div key={color} className="mb-4">
                <label className="block text-white/80 mb-1 capitalize">{color}</label>
                <input type="range" min="0" max="255" 
                  value={controls[color] || 0}
                  onChange={(e) => updateControl(color, parseInt(e.target.value))}
                  className="w-full h-2 bg-white/30 rounded-lg appearance-none cursor-pointer"
                />
                <span className="text-white/80">{controls[color] || 0}</span>
              </div>
            ))}
          </div>
          <div className="bg-white/20 backdrop-blur-lg p-6 rounded-2xl">
            <h3 className="text-xl font-bold text-white mb-4">üîä –ó—É–º–º–µ—Ä</h3>
            <button 
              className={`w-full p-4 rounded-xl text-xl font-bold ${controls.buzzer ? 'bg-red-500' : 'bg-gray-500'} text-white`}
              onClick={() => updateControl('buzzer', !controls.buzzer)}
            >
              {controls.buzzer ? 'üîá –í–´–ö–õ' : 'üîä –í–ö–õ'}
            </button>
          </div>
        </div>
      </div>
    </div>
  )
}
